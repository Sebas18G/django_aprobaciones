{% extends 'aprobaciones/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="fas fa-list text-primary"></i>
                Todas las Solicitudes
            </h1>
            <a href="{% url 'crear_solicitud' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nueva Solicitud
            </a>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="fas fa-filter text-info"></i> Filtros
                </h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="estado" class="form-label">Estado:</label>
                        <select name="estado" id="estado" class="form-control">
                            <option value="">Todos los estados</option>
                            <option value="pendiente" {% if estado_filtro == 'pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="en_revision" {% if estado_filtro == 'en_revision' %}selected{% endif %}>En Revisión</option>
                            <option value="aprobado" {% if estado_filtro == 'aprobado' %}selected{% endif %}>Aprobado</option>
                            <option value="rechazado" {% if estado_filtro == 'rechazado' %}selected{% endif %}>Rechazado</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="tipo" class="form-label">Tipo:</label>
                        <select name="tipo" id="tipo" class="form-control">
                            <option value="">Todos los tipos</option>
                            <option value="despliegue" {% if tipo_filtro == 'despliegue' %}selected{% endif %}>Despliegue</option>
                            <option value="acceso" {% if tipo_filtro == 'acceso' %}selected{% endif %}>Acceso</option>
                            <option value="cambio_tecnico" {% if tipo_filtro == 'cambio_tecnico' %}selected{% endif %}>Cambio Técnico</option>
                            <option value="pipeline" {% if tipo_filtro == 'pipeline' %}selected{% endif %}>Pipeline</option>
                            <option value="incorporacion" {% if tipo_filtro == 'incorporacion' %}selected{% endif %}>Incorporación</option>
                            <option value="otro" {% if tipo_filtro == 'otro' %}selected{% endif %}>Otro</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary me-2">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <a href="{% url 'listar_solicitudes' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Lista de solicitudes -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-list text-info"></i>
                    Solicitudes ({{ page_obj.paginator.count }} total)
                </h5>
            </div>
            <div class="card-body p-0">
                {% if page_obj %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Título</th>
                                    <th>Solicitante</th>
                                    <th>Responsable</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Fecha Creación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for solicitud in page_obj %}
                                <tr>
                                    <td>
                                        <code class="text-muted small">{{ solicitud.id|slice:":8" }}...</code>
                                    </td>
                                    <td>
                                        <strong>{{ solicitud.titulo|truncatechars:30 }}</strong>
                                        <br>
                                        <small class="text-muted">{{ solicitud.descripcion|truncatechars:50 }}</small>
                                    </td>
                                    <td>
                                        <i class="fas fa-user text-muted"></i>
                                        {{ solicitud.solicitante }}
                                    </td>
                                    <td>
                                        <i class="fas fa-user-check text-muted"></i>
                                        {{ solicitud.responsable }}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ solicitud.tipo_formateado }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ solicitud.color_estado }}">
                                            {% if solicitud.estado == 'pendiente' %}
                                                <i class="fas fa-hourglass-half"></i> Pendiente
                                            {% elif solicitud.estado == 'aprobado' %}
                                                <i class="fas fa-check-circle"></i> Aprobado
                                            {% elif solicitud.estado == 'rechazado' %}
                                                <i class="fas fa-times-circle"></i> Rechazado
                                            {% elif solicitud.estado == 'en_revision' %}
                                                <i class="fas fa-eye"></i> En Revisión
                                            {% else %}
                                                <i class="fas fa-question-circle"></i> {{ solicitud.estado|title }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ solicitud.fecha_formateada }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'detalle_solicitud' solicitud.id %}" 
                                               class="btn btn-outline-primary" 
                                               title="Ver detalle">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            {% if solicitud.estado == 'pendiente' %}
                                            <button class="btn btn-outline-success" 
                                                    title="Aprobar solicitud"
                                                    onclick="aprobarSolicitud('{{ solicitud.id }}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    title="Rechazar solicitud"
                                                    onclick="rechazarSolicitud('{{ solicitud.id }}')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginación -->
                    {% if page_obj.has_other_pages %}
                    <div class="card-footer bg-light">
                        <nav aria-label="Navegación de solicitudes">
                            <ul class="pagination justify-content-center mb-0">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if tipo_filtro %}&tipo={{ tipo_filtro }}{% endif %}">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if tipo_filtro %}&tipo={{ tipo_filtro }}{% endif %}">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                
                                <li class="page-item active">
                                    <span class="page-link">
                                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>
                                
                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if tipo_filtro %}&tipo={{ tipo_filtro }}{% endif %}">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if estado_filtro %}&estado={{ estado_filtro }}{% endif %}{% if tipo_filtro %}&tipo={{ tipo_filtro }}{% endif %}">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                    
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p class="h5">No se encontraron solicitudes</p>
                        <p>Intenta ajustar los filtros o crear una nueva solicitud</p>
                        <a href="{% url 'crear_solicitud' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Crear Nueva Solicitud
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function aprobarSolicitud(solicitudId) {
    if (confirm('¿Estás seguro de que deseas aprobar esta solicitud?')) {
        // Por ahora solo mostramos un mensaje
        // En el futuro implementaremos la funcionalidad real
        showToast('Funcionalidad de aprobación pendiente de implementar', 'warning');
    }
}

function rechazarSolicitud(solicitudId) {
    if (confirm('¿Estás seguro de que deseas rechazar esta solicitud?')) {
        // Por ahora solo mostramos un mensaje
        // En el futuro implementaremos la funcionalidad real
        showToast('Funcionalidad de rechazo pendiente de implementar', 'warning');
    }
}
</script>
{% endblock %}